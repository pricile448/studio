rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      // Les utilisateurs peuvent lire et créer leur propre document de profil
      allow read, create: if request.auth != null && request.auth.uid == userId;

      // Les utilisateurs peuvent mettre à jour leur profil sous certaines conditions
      allow update: if request.auth != null && request.auth.uid == userId
        // Règle 1: Les champs suivants sont immuables et ne peuvent pas être changés par l'utilisateur
        && request.resource.data.uid == resource.data.uid
        && request.resource.data.email == resource.data.email
        && request.resource.data.createdAt == resource.data.createdAt
        // Règle 2: L'IBAN et le BIC ne peuvent pas être définis ou modifiés par l'utilisateur
        && request.resource.data.get('iban', null) == resource.data.get('iban', null)
        && request.resource.data.get('bic', null) == resource.data.get('bic', null)
        // Règle 3: Un utilisateur ne peut pas se définir lui-même comme 'verified'.
        // Cette règle stipule : "le nouveau statut ne peut pas être 'verified' SAUF si l'ancien statut était déjà 'verified'".
        // Cela permet à un utilisateur déjà vérifié de modifier d'autres champs (comme son nom) sans être bloqué.
        && (request.resource.data.kycStatus == 'verified' ? resource.data.kycStatus == 'verified' : true);
    }
  }
}
