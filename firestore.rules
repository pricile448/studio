
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Fonction pour valider la transition du statut KYC.
    function isKycUpdateValid(incoming, existing) {
      // L'utilisateur ne peut que passer son statut de 'unverified' à 'pending'.
      // Il ne peut pas se donner le statut 'verified'.
      // Les autres statuts ne peuvent pas être modifiés par l'utilisateur une fois définis (ex: 'pending' ou 'verified').
      return (existing.kycStatus == 'unverified' && incoming.kycStatus == 'pending')
             || (existing.kycStatus == incoming.kycStatus);
    }

    match /users/{userId} {
      // Les utilisateurs peuvent lire leur propre profil s'ils sont authentifiés.
      allow read: if request.auth != null && request.auth.uid == userId;

      // Un nouvel utilisateur peut créer son propre profil.
      // Les règles de validation garantissent que les données initiales sont correctes.
      allow create: if request.auth != null && request.auth.uid == userId
                    && request.resource.data.uid == userId
                    && request.resource.data.email == request.auth.token.email
                    && request.resource.data.kycStatus == 'unverified';
      
      // Un utilisateur peut mettre à jour son propre profil, sous certaines conditions.
      allow update: if request.auth != null && request.auth.uid == userId
                    // Vérifie que les champs immuables ne sont pas modifiés.
                    && request.resource.data.uid == resource.data.uid
                    && request.resource.data.email == resource.data.email
                    && request.resource.data.createdAt == resource.data.createdAt
                    // Vérifie que la mise à jour du statut KYC est valide.
                    && isKycUpdateValid(request.resource.data, resource.data)
                    // Vérifie que seuls les champs autorisés sont modifiés.
                    && request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['firstName', 'lastName', 'dob', 'address', 'profession', 'salary', 'photoURL', 'notificationPrefs', 'kycStatus']);
    }
  }
}
