rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      // Les utilisateurs peuvent lire leur propre profil s'ils sont authentifiés.
      allow read: if request.auth != null && request.auth.uid == userId;

      // Un nouvel utilisateur peut créer son propre profil.
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // Un utilisateur peut mettre à jour son propre profil, avec des restrictions.
      allow update: if request.auth != null && request.auth.uid == userId &&
        // On ne peut pas modifier des champs immuables.
        !('uid' in request.writeFields) &&
        !('email' in request.writeFields) &&
        !('createdAt' in request.writeFields) &&
        !('pob' in request.writeFields) &&
        !('nationality' in request.writeFields) &&
        !('profession' in request.writeFields) &&
        !('salary' in request.writeFields) &&
        !('iban' in request.writeFields) &&
        !('bic' in request.writeFields) &&
        // La seule modification autorisée pour kycStatus est de 'unverified' à 'pending'.
        // Si kycStatus n'est pas modifié, cette condition est vraie.
        // Si kycStatus est modifié, la transition doit être valide.
        (
          !('kycStatus' in request.writeFields) ||
          (resource.data.kycStatus == 'unverified' && request.resource.data.kycStatus == 'pending')
        );
    }
  }
}
