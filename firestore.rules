
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Fonctions d'aide ---
    // Vérifie si l'utilisateur authentifié est un administrateur.
    function isAdmin() {
      // Un utilisateur est admin si son UID existe dans la collection 'admins'.
      return exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // --- Collection des administrateurs ---
    // Utilisée pour la vérification des permissions.
    // Seuls les utilisateurs authentifiés peuvent lire (pour vérifier leur propre statut).
    // L'écriture est désactivée côté client pour des raisons de sécurité.
    match /admins/{adminId} {
      allow read: if request.auth != null;
      allow write: if false; // La gestion des admins se fait via la console Firebase.
    }

    // --- Collection des utilisateurs ---
    match /users/{userId} {
      // Fonction d'aide pour vérifier si l'utilisateur est le propriétaire du document
      function isOwner() {
        return request.auth != null && request.auth.uid == userId;
      }

      // LECTURE ('get') : Autorisée pour le propriétaire du document ou un administrateur.
      allow get: if isOwner() || isAdmin();
      
      // LISTE ('list') : Autorisée uniquement pour les administrateurs.
      allow list: if isAdmin();

      // CRÉATION : Autorisée uniquement pour le propriétaire du document.
      allow create: if isOwner();

      // MISE À JOUR : Autorisée pour un administrateur (sans restriction) OU pour le propriétaire avec des règles strictes.
      allow update: if isAdmin() || (isOwner()
        // --- Champs Immuables (ne peuvent pas être modifiés par l'utilisateur) ---
        && request.resource.data.uid == resource.data.uid
        && request.resource.data.email == resource.data.email
        && request.resource.data.createdAt == resource.data.createdAt

        // --- Champs réservés à l'administration (ne peuvent pas être modifiés par l'utilisateur) ---
        // L'utilisateur ne peut pas s'auto-valider. Seul un admin peut passer le statut à 'verified'.
        && (
            (request.resource.data.kycStatus == 'pending' && resource.data.kycStatus == 'unverified') ||
            request.resource.data.kycStatus == resource.data.kycStatus
           )
        && request.resource.data.cardStatus == resource.data.cardStatus
        && request.resource.data.get('iban', null) == resource.data.get('iban', null)
        && request.resource.data.get('bic', null) == resource.data.get('bic', null)

        // --- Intégrité des soldes de comptes (l'utilisateur ne peut pas modifier les soldes) ---
        && request.resource.data.accounts.size() == resource.data.accounts.size()
        && (
          size(request.resource.data.accounts) == 0 ||
          (
            size(request.resource.data.accounts) > 0 &&
            request.resource.data.accounts[0].balance == resource.data.accounts[0].balance &&
            (size(request.resource.data.accounts) == 1 || request.resource.data.accounts[1].balance == resource.data.accounts[1].balance) &&
            (size(request.resource.data.accounts) == 2 || request.resource.data.accounts[2].balance == resource.data.accounts[2].balance)
          )
        )

        // --- Intégrité des transactions (l'utilisateur peut seulement en ajouter) ---
        && (
          request.resource.data.transactions.size() >= resource.data.transactions.size()
        )
      );
      
      // SUPPRESSION : Autorisée uniquement pour les administrateurs.
      allow delete: if isAdmin();
    }
    
    // --- Collection des conversations (chats) ---
    match /chats/{chatId} {
        // La lecture ('get') est autorisée si l'UID de l'utilisateur est dans l'ID du chat ou si l'utilisateur est un admin.
        allow get: if isAdmin() || (request.auth != null && request.auth.uid in chatId.split('_'));

        // La liste complète des conversations est réservée aux administrateurs (pour la vue conseiller).
        allow list: if isAdmin();

        // La création est autorisée si l'utilisateur fait partie des participants de la nouvelle conversation.
        allow create: if request.auth != null && request.auth.uid in request.resource.data.participants;
      
        // La mise à jour (pour le dernier message) est autorisée pour les participants ou un admin.
        allow update: if isAdmin() || (request.auth != null && request.auth.uid in resource.data.participants);
        
        // Seuls les administrateurs peuvent supprimer des conversations entières.
        allow delete: if isAdmin();

        // --- Sous-collection des messages ---
        match /messages/{messageId} {
            // Un utilisateur peut lire les messages d'une conversation s'il en est participant ou s'il est admin.
            allow read: if isAdmin() || (request.auth != null && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants);

            // Un utilisateur peut écrire un message s'il est participant ET s'il est l'auteur du message. Un admin peut aussi écrire.
            allow write: if isAdmin() || (request.auth != null 
                        && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants
                        && request.resource.data.senderId == request.auth.uid);
            
            // Personne ne peut supprimer un message individuel depuis le client pour garder l'intégrité.
            allow delete: if false;
        }
    }
  }
}
