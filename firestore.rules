rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Règle pour les profils utilisateurs
    // Permet à un utilisateur de lire et d'écrire son propre profil.
    match /users/{userId} {
      allow read, write: if request.auth.uid == userId;
    }

    // Règles pour les conversations (chats)
    match /chats/{chatId} {
      // Un utilisateur peut lire ou mettre à jour une conversation que s'il est participant.
      allow read, update: if request.auth.uid in resource.data.participants;

      // Un utilisateur peut créer une conversation si :
      // 1. Il est l'un des participants.
      // 2. L'ID du document correspond exactement aux participants triés (pour avoir des IDs déterministes).
      allow create: if request.auth.uid in request.resource.data.participants
                     && chatId == request.resource.data.participants.join('_');

      // Personne ne peut lister toutes les conversations ou les supprimer.
      allow list, delete: if false;

      // Règles pour les messages dans une conversation
      match /messages/{messageId} {
        // La lecture est autorisée si l'utilisateur fait partie de la conversation parente.
        allow read: if request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        
        // La création est autorisée si l'utilisateur est bien l'expéditeur et participe à la conversation.
        allow create: if request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants
                       && request.resource.data.senderId == request.auth.uid;

        // La mise à jour et la suppression des messages sont interdites pour le moment.
        allow update, delete: if false;
      }
    }
  }
}
